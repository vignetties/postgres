### patroni
- postgresql streaming replication
### postgresql streaming replication
- **PostgreSQL streaming replication** is based on transferring the WAL files from the primary to the target database. 
- **PostgreSQL streaming replication** is implemented using a master-slave configuration. The master is known as the primary instance and handles the primary database and its operations
- asynchronous (the default) or synchronous replication.
- Streaming Replication sends and applies WAL (Write Ahead Log) files from one database server (the master or primary), to a 'replica' (receiving database).
-  the WAL files from the master can be recycled before the standy has gotten them. One way to mitigate this is to increase the `wal_keep_segments` setting to a higher value


### to copy directory of postgres
`pg_basebackup` or `rsync`
### ip
Master 1 192.168.238.146
Master 2 192.168.238.147
```
postgres=# show config_file;
              config_file
----------------------------------------
 /var/lib/pgsql/12/data/postgresql.conf
```
```
postgres=# show hba_file;
              hba_file
------------------------------------
 /var/lib/pgsql/12/data/pg_hba.conf

```

### MASTER:
- step1: ALTER SYSTEM SET listen_addresses TO '*';
- step2: CREATE ROLE replicauser WITH REPLICATION PASSWORD 'zabbix' LOGIN;
- step3: 
-inside db-master/pg_hba.conf 
```
# Allow replication connections from 127.0.0.1, by a user with the replication privilege.
# TYPE  DATABASE        USER            ADDRESS                 METHOD
host    replication     replicauser    192.168.238.147/32            md5
```
- step5:
inside  db-master/postgresql.conf
```
wal_level = replica
archive_mode = on
max_wal_senders = 10 
wal_keep_segments = 10
hot_standby = on
archive_command = 'test ! -f /var/lib/pgsql/postgres_archive/%f && cp %p /var/lib/pgsql/postgres_archive/%f'
port = 5432
wal_log_hints = on

```

### SLAVE 
/usr/pgsql-12/bin/pg_basebackup -h 192.168.238.149 -U replicauser -p 5432 -D /var/lib/pgsql/12/data/ -Fp -Xs -P -R

data Permissions should be u=rwx (0700) or u=rwx,g=rx (0750)

just check this file :
```
############# db-slave/postgresql.auto.conf #############
# Do not edit this file manually!
# It will be overwritten by the ALTER SYSTEM command.
primary_conninfo = 'user=cary passfile=''/home/caryh/.pgpass'' host=127.0.0.1 port=5432 sslmode=prefer sslcompression=0 gssencmode=disable target_session_attrs=any'
```

just check standby.signal is there

inside  db-master/postgresql.conf

```
############# db-slave/postgresql.conf #############
wal_level = replica
archive_mode = on
max_wal_senders = 10 
wal_keep_segments = 10
hot_standby = on
archive_command = 'test ! -f /home/caryh/streaming-replication/archivedir/%f && cp %p /home/caryh/streaming-replication/archivedir/%f'
wal_log_hints = on
port = 5433
restore_command = 'cp /home/caryh/streaming-replication/archivedir/%f %p'
archive_cleanup_command = 'pg_archivecleanup /home/caryh/streaming-replication/archivedir %r'
```




restart postgres

to check replication:

Master : psql -d clusterdb -U cary -c "select * from pg_stat_replication;" -x -p 5432
slave:  psql -d zabbix -U postgres -c "select * from pg_stat_wal_receiver;" -x -p 5432


postgres=# select now()-pg_last_xact_replay_timestamp() as replication_lag;
 replication_lag
-----------------
 00:00:00.428784
(1 row)


ps -ef | grep postgres

-------------------------------------------------

check what is replication slot
____________________________
things to check before protection
- can we take base backeup while zabbix is running
- how to make the slave as master and master as slave
- how many wal logs or creating if we enable wal (monitor space utilization)
